# Babylon Metropolis Verlag Homepage

- [Babylon Metropolis Verlag Homepage](#babylon-metropolis-verlag-homepage)
- [Instalation](#instalation)
  - [Install Gatsby](#install-gatsby)
  - [Install Strapi](#install-strapi)
    - [Hoster specific configuration](#hoster-specific-configuration)
    - [Nodeversion](#nodeversion)
    - [Service Monitor and Manager](#service-monitor-and-manager)
  - [Development](#development)
    - [Browser Testing](#browser-testing)
    - [Strapi Docs](#strapi-docs)
  - [Build &amp; Deployment](#build-amp-deployment)
    - [Prefix Path](#prefix-path)
    - [Check speed](#check-speed)
  - [Maintenaince](#maintenaince)
    - [Database dump](#database-dump)
    - [Todos](#todos)

The [Babylon Metropolis](https://babylon-metropolis.com) homepage is a static site that is generated by the [Gatsby](https://www.gatsbyjs.org) and with [Strapi](https://strapi.io) as CMS.

The code is open (MIT) so the one can inspect it and maybe get inspired how to build a site with Gatsby and Strapi. For Stapi checkout the git repository [babylon-strapi](https://github.com/gitmathub/babylon-strapi).

# Instalation

Clone the repository and install.

## Install Gatsby

```bash
git clone https://github.com/gitmathub/babylon-gatsby.git
npm install

```

## Install Strapi

Check the most recent [Strapi documentation](https://strapi.io/documentation) > Guides > Deployment.

Make sure you're running a node version >= 10.

```sh
$ node -v
v10.8.0
```

Clone and install

```bash
git clone https://github.com/gitmathub/babylon-strapi.git
cd babylon-strapi/
npm install
```

Check and adjust your server settings `./config/environments/production/server.json.`

```bash
$ egrep 'host|port' config/environments/production/server.json
"host": "babylon-metropolis.de",
"port": 61337,
```

Build the admin panel.

```bash
NODE_ENV=production npm run build
```

Run the server.

```bash
NODE_ENV=production npm start
```

You should get this on the console:

```bash
To manage your project ðŸš€, go to the administration panel at:
http://babylon-metropolis.com:61337/admin

To access the server âš¡ï¸, go to:
http://babylon-metropolis.com:61337
```

Check if the API works

```bash
$ nc babylon-metropolis.com 61337
GET /categories

HTTP/1.1 403 Forbidden
```

### Hoster specific configuration

This section is very specific. It contains notes for my provider uberspace.de

### Nodeversion

https://wiki.uberspace.de/development:nodejs#versionen

### Service Monitor and Manager

https://wiki.uberspace.de/development:nodejs#einrichtung_als_dienst

```bash
uberspace-setup-service babylon-strapi npm start
```

check logs and ports

```bash
tail -f ~/service/babylon-strapi/log/main/current
```

patch start script

```bash
export NODE_ENV=production
cd $HOME/projects/babylon-strapi
exec node $HOME/projects/babylon-strapi/node_modules/.bin/strapi start 2>&1
```

service starting an stopping

```bash
# To start the service (hint: u = up):
svc -u ~/service/babylon-strapi
# To stop the service (hint: d = down):
svc -d ~/service/babylon-strapi
# To reload the service (hint: h = HUP):
svc -h ~/service/babylon-strapi
# To restart the service (hint: du = down, up):
svc -du ~/service/babylon-strapi
```

[firewall ports](https://wiki.uberspace.de/system:ports)

check on which ports services are running for user belab

```bash
 netstat -tulpe | grep belab
```

check which of your services are running

```bash
uberspace-list-ports --listen
```

check which ports of your firewall are open

```bash
uberspace-list-ports --open
```

open a port if needed

```bash
uberspace-add-port --protocol tcp --firewal
```

## Development

http://localhost:8000

http://localhost:8000/___graphql

### Browser Testing

Test in different browsers on Windows:
https://www.browserling.com

### Strapi Docs

- [config](https://strapi.io/documentation/3.0.0-beta.x/guides/deployment.html)
- [processmanager pm2](https://strapi.io/documentation/3.0.0-beta.x/guides/process-manager.html#install-pm2)
- [webhook](https://strapi.io/documentation/3.0.0-beta.x/guides/webhooks.html)
- [sqlite installation](https://strapi.io/documentation/3.0.0-beta.x/guides/databases.html#sqlite-installation)

## Build & Deployment

### Prefix Path

https://www.gatsbyjs.org/docs/recipes/deploying-your-site

Test deploy under the path prefix: `/next`

```js
module.exports = {
  pathPrefix: `/next`,
}
```

```bash
npm run build -- --prefix-paths
```

test

```bash
npm run serve -- --prefix-paths
```

http://localhost:9000/next

### Check speed

compression via `.htaccess`
(don't compress html for gatsby)

```
AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript text/javascript application/json
```

## Maintenaince

### Database dump

```bash
cd babylon-strapi/data
sqlite3 sqlite.db .dump > 20191226-02-strapi-babylon-dump.sql
```

### Todos

Must have

- [x] Footer navigation
- [x] Page with all items (Verlagsprogramm)
- [x] Authors page
- [x] SSL certificate
- [ ] CMS installation
  - [x] strapi installation
  - [x] pm2 installation
  - [x] data import
  - [ ] webhooks
- [ ] Deployment automation
- [x] Enable SSL after intallation

Good to have

- [ ] Web app manifest `gatsby-plugin-manifest`
- [ ] Meta tags
- [ ] Adjust link on Wikipedia

Goodies

- [ ] Favicon
- [ ] Listing of all authors
- [ ] Publication images
- [ ] Author images
- [ ] Hamburger menu: collapse when click outside
- [ ] Margin on windows internet explorer
- [ ] Coloring

- checkout https://github.com/staylor/react-helmet-async for resolving the warning about the _SideEffect(NullComponent)_: https://github.com/gatsbyjs/gatsby/issues/17865
